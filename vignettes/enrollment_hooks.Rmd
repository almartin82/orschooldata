---
title: "15 Insights from Oregon School Enrollment Data"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{15 Insights from Oregon School Enrollment Data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  message = FALSE,
  warning = FALSE,
  fig.width = 8,
  fig.height = 5
)
```

```{r load-packages}
library(orschooldata)
library(dplyr)
library(tidyr)
library(ggplot2)

theme_set(theme_minimal(base_size = 14))
```

This vignette explores Oregon's public school enrollment data, surfacing key trends across 15 years of data (2010-2024).

---

## 1. Oregon's enrollment peaked in 2019, then COVID hit

The state added students for a decade, then lost 26,000 in a single year during the pandemic.

```{r statewide-trend}
enr <- fetch_enr_multi(2010:2024, use_cache = TRUE)

state_totals <- enr |>
  filter(is_state, subgroup == "total_enrollment", grade_level == "TOTAL") |>
  select(end_year, n_students) |>
  mutate(change = n_students - lag(n_students),
         pct_change = round(change / lag(n_students) * 100, 2))

state_totals
```

```{r statewide-chart}
ggplot(state_totals, aes(x = end_year, y = n_students)) +
  geom_line(linewidth = 1.2, color = "#002855") +
  geom_point(size = 3, color = "#002855") +
  geom_vline(xintercept = 2020, linetype = "dashed", color = "red", alpha = 0.5) +
  annotate("text", x = 2020.5, y = max(state_totals$n_students, na.rm = TRUE),
           label = "COVID", hjust = 0, color = "red", size = 3) +
  scale_y_continuous(labels = scales::comma) +
  labs(
    title = "Oregon Public School Enrollment (2010-2024)",
    subtitle = "A decade of growth erased by pandemic disruption",
    x = "School Year (ending)",
    y = "Total Enrollment"
  )
```

---

## 2. Portland Public Schools is in steady decline

Oregon's largest district has lost thousands of students over the past decade, even as suburban districts have held steady.

```{r portland-decline}
portland <- enr |>
  filter(is_district, subgroup == "total_enrollment", grade_level == "TOTAL",
         district_id == "1920") |>
  select(end_year, district_name, n_students) |>
  mutate(pct_of_peak = round(n_students / max(n_students) * 100, 1))

portland
```

```{r top-districts-chart}
top_districts <- enr |>
  filter(is_district, subgroup == "total_enrollment", grade_level == "TOTAL",
         end_year == 2024) |>
  arrange(desc(n_students)) |>
  head(5) |>
  pull(district_id)

enr |>
  filter(is_district, subgroup == "total_enrollment", grade_level == "TOTAL",
         district_id %in% top_districts) |>
  ggplot(aes(x = end_year, y = n_students, color = district_name)) +
  geom_line(linewidth = 1.2) +
  geom_point(size = 2) +
  scale_y_continuous(labels = scales::comma) +
  labs(
    title = "Oregon's Top 5 Districts: Enrollment Trends",
    subtitle = "Portland shrinks while Salem-Keizer remains stable",
    x = "School Year",
    y = "Enrollment",
    color = "District"
  ) +
  theme(legend.position = "bottom") +
  guides(color = guide_legend(nrow = 2))
```

---

## 3. The COVID kindergarten collapse hasn't recovered

Kindergarten enrollment dropped 12% during the pandemic and remains below pre-COVID levels, signaling smaller cohorts for years to come.

```{r covid-k}
covid_grades <- enr |>
  filter(is_state, subgroup == "total_enrollment",
         grade_level %in% c("K", "01", "06", "09"),
         end_year %in% 2019:2024) |>
  select(end_year, grade_level, n_students) |>
  pivot_wider(names_from = grade_level, values_from = n_students)

covid_grades
```

```{r demographics-chart}
enr |>
  filter(is_state, subgroup == "total_enrollment", grade_level == "K") |>
  ggplot(aes(x = end_year, y = n_students)) +
  geom_line(linewidth = 1.2, color = "#4B9CD3") +
  geom_point(size = 3, color = "#4B9CD3") +
  geom_vline(xintercept = 2020, linetype = "dashed", color = "red", alpha = 0.5) +
  scale_y_continuous(labels = scales::comma) +
  labs(
    title = "Oregon Kindergarten Enrollment (2010-2024)",
    subtitle = "Pandemic dip has not fully recovered",
    x = "School Year (ending)",
    y = "Kindergarten Students"
  )
```

---

## 4. High school grades are larger than elementary

Grade 9 enrollment exceeds kindergarten by several thousand students, reflecting the pandemic's lasting impact on younger cohorts.

```{r hs-vs-elem}
enr_2024 <- fetch_enr(2024, use_cache = TRUE)

grade_comparison <- enr_2024 |>
  filter(is_state, subgroup == "total_enrollment",
         grade_level %in% c("K", "01", "02", "03", "09", "10", "11", "12")) |>
  select(grade_level, n_students) |>
  arrange(grade_level)

grade_comparison
```

---

## 5. 78 districts have fewer than 500 students

Rural Oregon is vast, and many small districts serve tiny populations spread across large geographic areas.

```{r small-districts}
district_sizes <- enr_2024 |>
  filter(is_district, subgroup == "total_enrollment", grade_level == "TOTAL") |>
  mutate(size_bucket = case_when(
    n_students < 500 ~ "Small (<500)",
    n_students < 2000 ~ "Medium (500-2K)",
    n_students < 10000 ~ "Large (2K-10K)",
    TRUE ~ "Very Large (10K+)"
  )) |>
  count(size_bucket)

district_sizes
```

```{r regional-chart}
district_sizes |>
  mutate(size_bucket = factor(size_bucket,
         levels = c("Small (<500)", "Medium (500-2K)", "Large (2K-10K)", "Very Large (10K+)"))) |>
  ggplot(aes(x = size_bucket, y = n, fill = size_bucket)) +
  geom_col(show.legend = FALSE) +
  geom_text(aes(label = n), vjust = -0.5) +
  scale_fill_brewer(palette = "Blues") +
  labs(
    title = "Oregon School Districts by Size",
    subtitle = "Most districts are small rural systems",
    x = "District Size Category",
    y = "Number of Districts"
  )
```

---

## 6. Multnomah County has more students than the bottom 20 counties combined

Oregon's urban-rural divide is stark. The Portland metro area dominates enrollment.

```{r county-enrollment}
county_enrollment <- enr_2024 |>
  filter(is_district, subgroup == "total_enrollment", grade_level == "TOTAL") |>
  group_by(county) |>
  summarize(
    districts = n(),
    students = sum(n_students, na.rm = TRUE)
  ) |>
  arrange(desc(students))

head(county_enrollment, 10)
```

```{r growth-chart}
county_enrollment |>
  head(10) |>
  mutate(county = forcats::fct_reorder(county, students)) |>
  ggplot(aes(x = students, y = county, fill = county)) +
  geom_col(show.legend = FALSE) +
  geom_text(aes(label = scales::comma(students)), hjust = -0.1, size = 3) +
  scale_x_continuous(labels = scales::comma, expand = expansion(mult = c(0, 0.15))) +
  scale_fill_viridis_d() +
  labs(
    title = "Oregon's Top 10 Counties by Enrollment",
    subtitle = "Portland metro dominates the state",
    x = "Total Students",
    y = NULL
  )
```

---

## 7. Lane County is Oregon's university town

Eugene and Springfield anchor Oregon's second-largest population center, with over 30,000 students between them.

```{r lane-county}
lane_districts <- enr_2024 |>
  filter(county == "Lane", is_district,
         subgroup == "total_enrollment", grade_level == "TOTAL") |>
  arrange(desc(n_students)) |>
  select(district_name, n_students) |>
  head(5)

lane_districts
```

---

## 8. Salem-Keizer is Oregon's largest district

With over 40,000 students, Salem-Keizer School District has surpassed Portland to become the state's enrollment leader.

```{r largest-districts}
largest <- enr_2024 |>
  filter(is_district, subgroup == "total_enrollment", grade_level == "TOTAL") |>
  arrange(desc(n_students)) |>
  select(district_name, n_students) |>
  head(10)

largest
```

---

## 9. Over 2,000 students are "ungraded"

Oregon tracks students not assigned to traditional grade levels, often in alternative programs or special education settings.

```{r ungraded}
ungraded <- enr |>
  filter(is_state, subgroup == "total_enrollment", grade_level == "UG") |>
  select(end_year, n_students)

ungraded
```

---

## 10. 15 years of data reveal long-term shifts

Oregon's enrollment data spans from 2010 to 2024, capturing the Great Recession recovery, pre-pandemic growth, COVID disruption, and early recovery.

```{r summary-table}
decade_summary <- enr |>
  filter(is_state, subgroup == "total_enrollment", grade_level == "TOTAL",
         end_year %in% c(2010, 2015, 2019, 2021, 2024)) |>
  select(end_year, n_students) |>
  mutate(label = case_when(
    end_year == 2010 ~ "Post-recession",
    end_year == 2015 ~ "Mid-decade",
    end_year == 2019 ~ "Pre-COVID peak",
    end_year == 2021 ~ "COVID low",
    end_year == 2024 ~ "Current"
  ))

decade_summary
```

---

## 11. Eastern Oregon is losing students fastest

Malheur, Harney, and other eastern counties face declining enrollment as young families leave for urban jobs.

```{r eastern-decline}
eastern_counties <- c("Malheur", "Harney", "Baker", "Grant", "Wheeler", "Gilliam", "Sherman")

eastern_trend <- enr |>
  filter(is_district, subgroup == "total_enrollment", grade_level == "TOTAL",
         county %in% eastern_counties) |>
  group_by(end_year, county) |>
  summarize(students = sum(n_students, na.rm = TRUE), .groups = "drop")

# Compare first and last available years
eastern_summary <- eastern_trend |>
  group_by(county) |>
  summarize(
    first_year = min(end_year),
    last_year = max(end_year),
    first_enr = students[end_year == min(end_year)],
    last_enr = students[end_year == max(end_year)],
    pct_change = round((last_enr / first_enr - 1) * 100, 1),
    .groups = "drop"
  )

eastern_summary
```

```{r eastern-chart}
ggplot(eastern_trend, aes(x = end_year, y = students, color = county)) +
  geom_line(linewidth = 1.2) +
  geom_point(size = 2) +
  scale_y_continuous(labels = scales::comma) +
  labs(
    title = "Eastern Oregon Enrollment Decline (2010-2024)",
    subtitle = "Rural counties losing students to urban migration",
    x = "School Year (ending)",
    y = "Total Enrollment",
    color = "County"
  ) +
  theme(legend.position = "right")
```

---

## 12. Beaverton vs Hillsboro: Suburban rivals

Washington County's two largest districts show different trajectories over the past decade.

```{r beaverton-hillsboro}
wash_county <- enr |>
  filter(is_district, subgroup == "total_enrollment", grade_level == "TOTAL",
         district_name %in% c("Beaverton SD 48J", "Hillsboro SD 1J")) |>
  select(end_year, district_name, n_students)

wash_county |>
  filter(end_year %in% c(2010, 2015, 2020, 2024))
```

```{r suburban-chart}
wash_county |>
  ggplot(aes(x = end_year, y = n_students, color = district_name)) +
  geom_line(linewidth = 1.5) +
  geom_point(size = 3) +
  scale_y_continuous(labels = scales::comma) +
  scale_color_manual(values = c("Beaverton SD 48J" = "#1e3d59", "Hillsboro SD 1J" = "#ff6e40")) +
  labs(
    title = "Washington County's Suburban Giants",
    subtitle = "Beaverton and Hillsboro: two paths through growth and COVID",
    x = "School Year (ending)",
    y = "Total Enrollment",
    color = "District"
  ) +
  theme(legend.position = "bottom")
```

---

## 13. Pre-K enrollment is booming

Oregon's pre-kindergarten programs have grown dramatically, reflecting expanded early childhood education investment.

```{r prek-growth}
prek_trend <- enr |>
  filter(is_state, subgroup == "total_enrollment", grade_level == "PK") |>
  select(end_year, n_students) |>
  mutate(growth_from_2010 = round((n_students / first(n_students) - 1) * 100, 1))

prek_trend
```

```{r prek-chart}
ggplot(prek_trend, aes(x = end_year, y = n_students)) +
  geom_area(fill = "#7fb069", alpha = 0.7) +
  geom_line(linewidth = 1.2, color = "#3d5a45") +
  geom_point(size = 2, color = "#3d5a45") +
  scale_y_continuous(labels = scales::comma) +
  labs(
    title = "Oregon Pre-K Enrollment Growth (2010-2024)",
    subtitle = "Early childhood education expands statewide",
    x = "School Year (ending)",
    y = "Pre-K Students"
  )
```

---

## 14. Central Oregon is the growth story

Deschutes County (Bend) has bucked statewide trends with consistent enrollment growth as families migrate from California and Portland.

```{r central-oregon}
central_oregon <- c("Deschutes", "Jefferson", "Crook")

central_trend <- enr |>
  filter(is_district, subgroup == "total_enrollment", grade_level == "TOTAL",
         county %in% central_oregon) |>
  group_by(end_year, county) |>
  summarize(students = sum(n_students, na.rm = TRUE), .groups = "drop")

# Compare first and last available years
central_summary <- central_trend |>
  group_by(county) |>
  summarize(
    first_year = min(end_year),
    last_year = max(end_year),
    first_enr = students[end_year == min(end_year)],
    last_enr = students[end_year == max(end_year)],
    pct_change = round((last_enr / first_enr - 1) * 100, 1),
    .groups = "drop"
  )

central_summary
```

```{r central-chart}
ggplot(central_trend, aes(x = end_year, y = students, fill = county)) +
  geom_area(alpha = 0.8, position = "stack") +
  scale_y_continuous(labels = scales::comma) +
  scale_fill_brewer(palette = "Oranges") +
  labs(
    title = "Central Oregon Enrollment Growth (2010-2024)",
    subtitle = "Bend area attracts families fleeing Portland and California",
    x = "School Year (ending)",
    y = "Total Enrollment",
    fill = "County"
  ) +
  theme(legend.position = "bottom")
```

---

## 15. Grade-by-grade snapshot reveals demographic wave

Each grade level tells a story: today's kindergartners are tomorrow's high schoolers.

```{r grade-wave}
grade_snapshot <- enr |>
  filter(is_state, subgroup == "total_enrollment",
         grade_level %in% c("K", "01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"),
         end_year == 2024) |>
  select(grade_level, n_students) |>
  arrange(grade_level)

grade_snapshot
```

```{r grade-wave-chart}
grade_snapshot |>
  mutate(grade_level = factor(grade_level, levels = c("K", sprintf("%02d", 1:12)))) |>
  ggplot(aes(x = grade_level, y = n_students, fill = n_students)) +
  geom_col() +
  geom_text(aes(label = scales::comma(n_students)), vjust = -0.3, size = 3) +
  scale_y_continuous(labels = scales::comma, expand = expansion(mult = c(0, 0.1))) +
  scale_fill_viridis_c(option = "plasma", guide = "none") +
  labs(
    title = "2024 Oregon Enrollment by Grade",
    subtitle = "Larger high school cohorts, smaller elementary classes",
    x = "Grade Level",
    y = "Students"
  )
```

---

## Summary

Oregon's school enrollment data reveals:
- **Pandemic disruption**: Enrollment peaked in 2019 and is still recovering
- **Urban decline**: Portland Public Schools continues to shrink
- **Rural challenges**: 78 districts have fewer than 500 students
- **Metro dominance**: Multnomah County eclipses rural Oregon
- **Kindergarten gap**: COVID's impact on youngest cohorts persists
- **Eastern exodus**: Rural counties losing students to urban migration
- **Suburban divergence**: Beaverton and Hillsboro on different growth paths
- **Pre-K expansion**: Early childhood education seeing dramatic growth
- **Central Oregon boom**: Bend area bucking statewide decline trends
- **Grade-level dynamics**: High school cohorts larger than elementary

These patterns shape school funding, facility planning, and staffing decisions across the Beaver State.

---

*Data sourced from the Oregon Department of Education [Fall Membership Reports](https://www.oregon.gov/ode/reports-and-data/students/Pages/Fall-Membership-Report.aspx).*
